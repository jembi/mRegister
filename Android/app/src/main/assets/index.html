<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LHC-Forms FHIR R5 Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="styles.css" rel="stylesheet" />
</head>
<body>
<div id="myFormContainer"></div>

<script src="zone.min.js"></script>
<script src="lhc-forms.js"></script>
<script src="lformsFHIR.min.js"></script>

<script>
  // Use the special WebViewAssetLoader base URL
  const BASE_QUESTIONNAIRE_URL = "https://appassets.androidplatform.net/assets/questionnaires";

  function loadLocalJson(path, callback) {
    const xhr = new XMLHttpRequest();
    xhr.overrideMimeType("application/json");
    xhr.open('GET', path, true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        if (xhr.status == 200 || xhr.status === 0) {
          callback(JSON.parse(xhr.responseText));
        } else {
          console.error("Failed to load JSON from:", path, "Status:", xhr.status);
        }
      }
    };
    xhr.send(null);
  }

  function injectExpansionFromCompose(valueSet) {
    if (!valueSet.expansion && valueSet.compose?.include?.length) {
      valueSet.expansion = { contains: [] };
      valueSet.compose.include.forEach(inc => {
        (inc.concept || []).forEach(concept => {
          valueSet.expansion.contains.push({
            system: inc.system,
            code: concept.code,
            display: concept.display
          });
        });
      });
    }
  }

  function collectAnswers(items, answeredItems = []) {
    items.forEach(item => {
      if (item.value !== undefined && item.value !== null && item.value !== '') {
        answeredItems.push({
          code: item.questionCode,
          value: item.value
        });
      }
      if (item.items && item.items.length > 0) {
        collectAnswers(item.items, answeredItems);
      }
    });
    return answeredItems;
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadLocalJson(`${BASE_QUESTIONNAIRE_URL}/questionnaire1-schema.json`, function (parentQ) {
      loadLocalJson(`${BASE_QUESTIONNAIRE_URL}/questionnaire2-schema.json`, function (childQ) {

        // Handle ValueSets
        if (parentQ.contained) {
          for (let res of parentQ.contained) {
            if (res.resourceType === 'ValueSet') {
              injectExpansionFromCompose(res);
            }
          }
        }

        // Merge child into parent at placeholder
        const placeholderItem = parentQ.item.find(it => it.linkId === 'HIV.D4ScreenForTb.History');
        if (placeholderItem && Array.isArray(childQ.item)) {
          placeholderItem.item = childQ.item;
        }

        // Convert and render
        LForms.Util.setFHIRContext(parentQ);
        const lfData = LForms.Util.convertFHIRQuestionnaireToLForms(parentQ, 'R5');
        LForms.Util.addFormToPage(lfData, 'myFormContainer');

        // Add submit button
        const submitBtn = document.createElement('button');
        submitBtn.type = 'button';
        submitBtn.innerText = 'Submit Form';
        submitBtn.style.marginTop = '1em';
        document.getElementById('myFormContainer').appendChild(submitBtn);

        submitBtn.addEventListener('click', function () {
          try {
            const formElement = document.querySelector('#myFormContainer > div');
            const formData = LForms.Util.getFormData(formElement);
            const answeredItems = collectAnswers(formData.items || []);
            console.log('Answered items:', JSON.stringify(answeredItems, null, 2));

            sendDataToWhatsApp(answeredItems);

          } catch (error) {
            console.error('Error collecting form data:', error);
          }
        });
      });
    });
  });

  function sendDataToWhatsApp(data) {
  let message = 'Form Submission:\n';
  data.forEach(item => {
    let displayValue = '';

    if (Array.isArray(item.value)) {
      displayValue = item.value.map(val => val.display || val.code || val).join(', ');
    } else if (typeof item.value === 'object') {
      displayValue = item.value.display || item.value.code || JSON.stringify(item.value);
    } else {
      displayValue = item.value;
    }

    message += `â€¢ ${item.code}: ${displayValue}\n`;
  });

  const phoneNumber = '27832791564';
  const encodedMessage = encodeURIComponent(message);
  const whatsappURL = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;

  // Send the URL to the Android app
  if (window.AndroidInterface) {
    window.AndroidInterface.openWhatsApp(whatsappURL);
  } else {
    alert('Android interface not available.');
  }
}


</script>
</body>
</html>
