<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LHC-Forms FHIR R5 Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="styles.css" rel="stylesheet" />
</head>
<body>
<div id="myFormContainer"></div>

<script src="zone.min.js"></script>
<script src="lhc-forms.js"></script>
<script src="lformsFHIR.min.js"></script>

<script>
  const BASE_QUESTIONNAIRE_URL = "https://appassets.androidplatform.net/assets/questionnaires";

  function loadLocalJson(path, callback) {
    const xhr = new XMLHttpRequest();
    xhr.overrideMimeType("application/json");
    xhr.open('GET', path, true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        if (xhr.status == 200 || xhr.status === 0) {
          callback(JSON.parse(xhr.responseText));
        } else {
          console.error("Failed to load JSON from:", path, "Status:", xhr.status);
        }
      }
    };
    xhr.send(null);
  }

  function injectExpansionFromCompose(valueSet) {
    if (!valueSet.expansion && valueSet.compose?.include?.length) {
      valueSet.expansion = { contains: [] };
      valueSet.compose.include.forEach(inc => {
        (inc.concept || []).forEach(concept => {
          valueSet.expansion.contains.push({
            system: inc.system,
            code: concept.code,
            display: concept.display
          });
        });
      });
    }
  }

  function collectAnswers(items, answeredItems = []) {
    items.forEach(item => {
      if (item.value !== undefined && item.value !== null && item.value !== '') {
        answeredItems.push({
          code: item.questionCode,
          value: item.value
        });
      }
      if (item.items && item.items.length > 0) {
        collectAnswers(item.items, answeredItems);
      }
    });
    return answeredItems;
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadLocalJson(`${BASE_QUESTIONNAIRE_URL}/questionnaire1-schema.json`, function (parentQ) {
      loadLocalJson(`${BASE_QUESTIONNAIRE_URL}/questionnaire2-schema.json`, function (childQ) {

        if (parentQ.contained) {
          for (let res of parentQ.contained) {
            if (res.resourceType === 'ValueSet') {
              injectExpansionFromCompose(res);
            }
          }
        }

        const placeholderItem = parentQ.item.find(it => it.linkId === 'HIV.D4ScreenForTb.History');
        if (placeholderItem && Array.isArray(childQ.item)) {
          placeholderItem.item = childQ.item;
        }

        LForms.Util.setFHIRContext(parentQ);
        const lfData = LForms.Util.convertFHIRQuestionnaireToLForms(parentQ, 'R5');
        LForms.Util.addFormToPage(lfData, 'myFormContainer');

        const submitBtn = document.createElement('button');
        submitBtn.type = 'button';
        submitBtn.innerText = 'Submit Form';
        submitBtn.style.marginTop = '1em';
        document.getElementById('myFormContainer').appendChild(submitBtn);

        submitBtn.addEventListener('click', function () {
          try {
            const formElement = document.querySelector('#myFormContainer > div');
            const formData = LForms.Util.getFormData(formElement);
            const answeredItems = collectAnswers(formData.items || []);
            console.log('Answered items:', JSON.stringify(answeredItems, null, 2));

            sendDataToWhatsApp(answeredItems);
          } catch (error) {
            console.error('Error collecting form data:', error);
          }
        });
      });
    });
  });

  function sendDataToWhatsApp(data) {
    const formattedData = {};

    data.forEach(item => {
      let value;

      if (Array.isArray(item.value)) {
        value = item.value.map(val => {
          if (typeof val === 'object' && val.code && val.system) {
            return {
              code: val.code,
              display: val.display || '',
              system: val.system
            };
          }
          return val;
        });
      } else if (typeof item.value === 'object' && item.value.code && item.value.system) {
        value = {
          code: item.value.code,
          display: item.value.display || '',
          system: item.value.system
        };
      } else {
        value = item.value;
      }

      formattedData[item.code] = {
        value: value
      };
    });

    const jsonMessage = JSON.stringify(formattedData, null, 2);
    const phoneNumber = '27832791564';
    const encodedMessage = encodeURIComponent("Form Submission:\n" + jsonMessage);
    const whatsappURL = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;

    if (window.AndroidInterface) {
      window.AndroidInterface.openWhatsApp(whatsappURL);
    } else {
      alert('Android interface not available.');
    }
  }
</script>
</body>
</html>
